# =============================================================================
# ⚠️  DEPRECATED - Documentation Only, Not Enforced at Runtime
# =============================================================================
# Replacement: context-inference.sh (CAPS - Context-Aware Permission System)
# Migration Guide: See specs/014-context-aware-permission-system/
# Removal Date: 2025-02-01
#
# This schema is kept for reference only. Checkpoint validation is handled
# inline by workflow-checkpoint.sh. CAPS provides stateless context inference.
# =============================================================================

# =============================================================================
# Checkpoint Schema (LEGACY)
# =============================================================================
# Defines the structure for workflow checkpoints that track progress,
# enable resumption, and maintain integrity across agent operations.
#
# Version: 1.0.0
# Tasks: T001, T018
# =============================================================================

schema:
  name: Checkpoint
  version: "1.0.0"
  description: "Schema for workflow checkpoints and state preservation"

# -----------------------------------------------------------------------------
# Field Definitions
# -----------------------------------------------------------------------------
fields:

  # ---------------------------------------------------------------------------
  # checkpoint_id
  # ---------------------------------------------------------------------------
  # Unique identifier for each checkpoint
  # Format: chk-{timestamp_short}-{random}
  # Example: "chk-20250115-a1b2c3"
  checkpoint_id:
    type: string
    required: true
    unique: true
    pattern: "^chk-[0-9]{8}-[a-z0-9]{6}$"
    description: "Unique identifier for this checkpoint"
    example: "chk-20250115-a1b2c3"

  # ---------------------------------------------------------------------------
  # phase
  # ---------------------------------------------------------------------------
  # Current workflow phase when checkpoint was created
  # Represents the stage in the development lifecycle
  phase:
    type: string
    required: true
    enum:
      - init        # Initial setup and agent registration
      - research    # Gathering context and analyzing requirements
      - planning    # Creating specs, plans, and task breakdowns
      - implement   # Active code/docs implementation
      - review      # Validation, testing, and quality checks
      - complete    # All tasks finished, ready for merge/deploy
    description: "Workflow phase at checkpoint creation"
    example: "implement"
    
    # Phase transition rules (for reference)
    transitions:
      init: [research, planning]
      research: [planning, init]
      planning: [implement, research]
      implement: [review, planning]
      review: [complete, implement]
      complete: []  # Terminal state

  # ---------------------------------------------------------------------------
  # timestamp
  # ---------------------------------------------------------------------------
  # When this checkpoint was created
  # ISO 8601 format with timezone for cross-system compatibility
  timestamp:
    type: string
    format: iso8601
    required: true
    immutable: true
    description: "ISO 8601 timestamp of checkpoint creation"
    example: "2025-01-15T14:45:30Z"

  # ---------------------------------------------------------------------------
  # artifacts
  # ---------------------------------------------------------------------------
  # Array of file paths that were created or modified
  # Relative to workspace root for portability
  artifacts:
    type: array
    items:
      type: string
      format: relative_path
    required: true
    min_items: 0
    description: "List of files created or modified at this checkpoint"
    example:
      - ".claude/configs/agent-schema.yaml"
      - ".claude/configs/checkpoint-schema.yaml"
      - "specs/061-parallel-agent-hooks-audit/plan.md"

  # ---------------------------------------------------------------------------
  # state_hash
  # ---------------------------------------------------------------------------
  # SHA-256 hash of checkpoint state for integrity verification
  # Computed from: phase + artifacts + agent_id + timestamp
  state_hash:
    type: string
    format: sha256
    required: true
    pattern: "^[a-f0-9]{64}$"
    description: "SHA-256 hash for checkpoint integrity verification"
    example: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"
    
    # Hash computation (pseudocode):
    # hash_input = f"{phase}|{sorted(artifacts)}|{agent_id}|{timestamp}"
    # state_hash = sha256(hash_input).hexdigest()

  # ---------------------------------------------------------------------------
  # agent_id
  # ---------------------------------------------------------------------------
  # Reference to the agent that created this checkpoint
  # Must match a valid agent_id from agent-schema
  agent_id:
    type: string
    required: true
    foreign_key: "agent-schema.agent_id"
    pattern: "^[a-z]+-[a-z0-9]+-[0-9]{3}$"
    description: "ID of the agent that created this checkpoint"
    example: "orchestrator-abc123-001"

  # ---------------------------------------------------------------------------
  # summary
  # ---------------------------------------------------------------------------
  # Human-readable description of checkpoint state
  # Optional but recommended for debugging and history
  summary:
    type: string
    required: false
    nullable: true
    max_length: 500
    description: "Human-readable summary of checkpoint state"
    example: "Completed schema definitions for agent and checkpoint configs"

  # ---------------------------------------------------------------------------
  # previous_checkpoint
  # ---------------------------------------------------------------------------
  # Reference to the prior checkpoint in the chain
  # Null for the first checkpoint in a session
  # Enables checkpoint chain traversal and rollback
  previous_checkpoint:
    type: string
    required: false
    nullable: true
    foreign_key: "checkpoint-schema.checkpoint_id"
    pattern: "^chk-[0-9]{8}-[a-z0-9]{6}$"
    description: "ID of the previous checkpoint in the chain"
    example: "chk-20250115-xyz789"
    
    # Chain structure:
    # checkpoint_1 <- checkpoint_2 <- checkpoint_3 (current)
    #     ^                ^               ^
    #     |                |               |
    # previous=null   previous=1      previous=2

# -----------------------------------------------------------------------------
# Validation Rules
# -----------------------------------------------------------------------------
validation:
  # Ensure checkpoint_id follows naming convention
  - rule: "checkpoint_id must match pattern chk-{date}-{random}"
    field: checkpoint_id
    
  # Ensure state_hash is valid SHA-256
  - rule: "state_hash must be 64 hex characters"
    field: state_hash
    
  # Ensure phase transitions are valid
  - rule: "phase must follow valid transition rules"
    field: phase
    
  # Ensure previous_checkpoint exists if specified
  - rule: "previous_checkpoint must reference existing checkpoint"
    field: previous_checkpoint
    when: "previous_checkpoint is not null"

  # Ensure artifacts are relative paths
  - rule: "artifacts must be relative paths (no leading /)"
    field: artifacts

# -----------------------------------------------------------------------------
# Indexes (for efficient querying)
# -----------------------------------------------------------------------------
indexes:
  - name: "idx_checkpoint_phase"
    fields: [phase]
    description: "Quick lookup by workflow phase"
    
  - name: "idx_checkpoint_agent"
    fields: [agent_id]
    description: "Find all checkpoints by agent"
    
  - name: "idx_checkpoint_timestamp"
    fields: [timestamp]
    description: "Chronological ordering"
    
  - name: "idx_checkpoint_chain"
    fields: [previous_checkpoint]
    description: "Traverse checkpoint chain"

# -----------------------------------------------------------------------------
# Example Checkpoint
# -----------------------------------------------------------------------------
example:
  checkpoint_id: "chk-20250115-a1b2c3"
  phase: "implement"
  timestamp: "2025-01-15T14:45:30Z"
  artifacts:
    - ".claude/configs/agent-schema.yaml"
    - ".claude/configs/checkpoint-schema.yaml"
  state_hash: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"
  agent_id: "orchestrator-abc123-001"
  summary: "Created agent and checkpoint configuration schemas"
  previous_checkpoint: "chk-20250115-xyz789"

# -----------------------------------------------------------------------------
# Checkpoint Chain Example
# -----------------------------------------------------------------------------
chain_example:
  description: "Example of checkpoint chain for a typical workflow"
  checkpoints:
    - checkpoint_id: "chk-20250115-000001"
      phase: "init"
      summary: "Session initialized, agents registered"
      previous_checkpoint: null
      
    - checkpoint_id: "chk-20250115-000002"
      phase: "planning"
      summary: "Spec folder created, tasks defined"
      previous_checkpoint: "chk-20250115-000001"
      
    - checkpoint_id: "chk-20250115-000003"
      phase: "implement"
      summary: "Schema files created"
      previous_checkpoint: "chk-20250115-000002"
