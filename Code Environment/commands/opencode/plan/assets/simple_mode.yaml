# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PLAN: SIMPLE MODE WORKFLOW (PARAMETERIZED - OPENCODE)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
role: Expert Planning Orchestrator with Parameterized Models
purpose: Create comprehensive specification and implementation plan with parallel exploration
action: Execute 9-phase planning workflow producing SpecKit-compliant documentation

operating_mode:
  workflow: sequential_9_phase
  workflow_compliance: MANDATORY
  workflow_execution: autonomous_with_user_review
  approvals: plan_review_before_implementation
  tracking: phase_progress_transparent
  validation: speckit_template_compliance

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MODEL PARAMETERS (SET BY PARENT COMMAND)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# The parent command (with_claude.md, with_gpt.md, with_gemini.md) specifies
# which models to use. This file adapts its behavior accordingly.
#
# Usage: Parent command sets parameters before loading this file
#   - with_claude.md â†’ ORCHESTRATOR_MODEL=claude, AGENT_MODEL=sonnet
#   - with_gpt.md â†’ ORCHESTRATOR_MODEL=gpt, AGENT_MODEL=sonnet
#   - with_gemini.md â†’ ORCHESTRATOR_MODEL=gemini, AGENT_MODEL=sonnet
#
# If parameters not set, defaults for backward compatibility:
#   - ORCHESTRATOR_MODEL defaults to "claude"
#   - AGENT_MODEL defaults to "sonnet"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model_config:
  orchestrator_param: ORCHESTRATOR_MODEL
  agent_param: AGENT_MODEL
  defaults:
    orchestrator: claude
    agent: sonnet
  valid_orchestrators: ["claude", "gpt", "gemini"]
  valid_agents: ["sonnet", "haiku"]

  orchestrator_characteristics:
    claude:
      name: "Claude"
      description: "Anthropic Claude for task understanding, verification, synthesis"
      approach: "Claude orchestrates and verifies Sonnet exploration findings"
      estimated_duration: "50-100 seconds"
    gpt:
      name: "GPT"
      description: "OpenAI GPT for task understanding, verification, synthesis"
      approach: "GPT orchestrates and verifies Sonnet exploration findings"
      estimated_duration: "50-100 seconds"
      note: "Requires OpenCode Copilot integration"
    gemini:
      name: "Gemini"
      description: "Google Gemini for task understanding, verification, synthesis"
      approach: "Gemini orchestrates and verifies Sonnet exploration findings"
      estimated_duration: "50-100 seconds"
      note: "May include web research capabilities"

  agent_characteristics:
    sonnet:
      name: "Sonnet"
      description: "Fast, cost-effective exploration"
      estimated_duration: "15-35 seconds for 4 agents"
      best_for: "Standard features, quick iterations, cost-sensitive projects"

planning_philosophy:
  principle: "Explore thoroughly, plan precisely, verify continuously"
  approach: "{ORCHESTRATOR_MODEL} orchestrates, {AGENT_MODEL} explores in parallel, {ORCHESTRATOR_MODEL} verifies"
  mandate: "Never assume - verify by reading files. Report findings, not conclusions."
  orchestrator_model: "{ORCHESTRATOR_MODEL}"  # Set by parent command
  agent_model: "{AGENT_MODEL}"  # Set by parent command (typically sonnet)
  estimated_duration: "{orchestrator_characteristics[ORCHESTRATOR_MODEL].estimated_duration}"

output_structure:
  level_1_baseline: "spec.md + plan.md + tasks.md"
  level_2_verification: "Level 1 + checklist.md"
  level_3_full: "Level 2 + decision-record.md + optional research-spike.md"
  speckit_alignment: "MANDATORY - follows AGENTS.md Section 2"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# NOTE: This is a self-contained workflow file merging:
# - Phase 0: Documentation Level Detection (SpecKit alignment)
# - base_phases.yaml (Phases 1-3, 7-8)
# - exploration.yaml (Phases 4-5)
# - Phase 6: SpecKit document creation (spec.md + plan.md)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 0: DOCUMENTATION LEVEL DETECTION (SpecKit Alignment)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_0_documentation_level:
  phase_name: "Documentation Level Detection"
  emoji: "ğŸ“Š"
  purpose: "Determine SpecKit documentation level (1, 2, or 3) per AGENTS.md Section 2"
  mandatory: "All plan commands create AT LEAST Level 1 documentation"

  level_structure:
    description: "Progressive Enhancement Model"
    levels:
      level_1:
        name: "Baseline"
        required_files: ["spec.md", "plan.md", "tasks.md"]
        description: "All tasks get this minimum"
      level_2:
        name: "Verification"
        required_files: ["spec.md", "plan.md", "tasks.md", "checklist.md"]
        description: "Level 1 + checklist.md for tasks needing verification"
      level_3:
        name: "Full"
        required_files: ["spec.md", "plan.md", "tasks.md", "checklist.md", "decision-record.md"]
        optional_files: ["research-spike.md", "research.md"]
        description: "Level 2 + decision-record.md for complex/architectural tasks"

  steps:
    step_0_1_extract_loc_estimate:
      action: "Extract LOC estimate from parent command mode detection"
      note: "Parent command (with_claude_code.md) already calculated this"
      source: "Mode selection logic in parent command"
      fallback: "If not available, estimate from task description keywords"

    step_0_2_apply_decision_matrix:
      action: "Apply SpecKit decision matrix from AGENTS.md Section 2"
      note: "LOC thresholds are SOFT GUIDANCE, hooks enforce HARD requirements"
      logic: |
        # Progressive Enhancement Decision Matrix
        # LOC thresholds are suggestions, not hard rules

        if any_task:
          # Level 1 is the BASELINE for all tasks
          documentation_level = 1
          required_files = ["spec.md", "plan.md", "tasks.md"]
          optional_files = []
          rationale = "Baseline documentation for any task"

        if needs_verification OR loc_estimate >= 100:
          # Level 2 adds verification checklist
          documentation_level = 2
          required_files = ["spec.md", "plan.md", "tasks.md", "checklist.md"]
          optional_files = []
          rationale = "Task needs verification tracking"

        if complex_or_architectural OR loc_estimate >= 500:
          # Level 3 adds decision documentation
          documentation_level = 3
          required_files = ["spec.md", "plan.md", "tasks.md", "checklist.md", "decision-record.md"]
          optional_files = ["research-spike.md", "research.md"]
          rationale = "Complex task requires decision documentation"

    step_0_3_check_secondary_factors:
      action: "Check secondary factors that can override LOC suggestion"
      note: "These factors can bump the level UP, never down"
      factors:
        complexity:
          high_indicators: ["architecture change", "system redesign", "multi-service"]
          action_if_high: "Bump to Level 3"
        risk:
          high_indicators: ["authentication", "security", "data migration", "breaking change"]
          action_if_high: "Bump to Level 3"
        verification_needed:
          indicators: ["testing required", "QA review", "performance validation"]
          action_if_true: "Bump to Level 2 minimum"
        dependencies:
          multiple_systems: true
          action_if_true: "Consider Level 3"
      note: "When in doubt, choose higher level (AGENTS.md guidance)"

    step_0_4_store_level:
      action: "Store documentation level for use in Phase 6"
      outputs:
        - documentation_level  # 1, 2, or 3
        - required_files       # Level-specific required templates
        - optional_files       # Level-specific optional templates (Level 3 only)
        - level_rationale      # Justification for level selection

  outputs:
    - documentation_level  # 1, 2, or 3
    - required_files
    - optional_files
    - level_rationale

  notification:
    format: |
      SpecKit Documentation Level: {documentation_level}
      Required Files: {required_files}
      Rationale: {level_rationale}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 1: TASK UNDERSTANDING & SESSION INITIALIZATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_1_task_understanding:
  phase_name: "Task Understanding & Session Initialization"
  emoji: "ğŸ“‹"
  purpose: "Parse input, validate task description, extract SESSION_ID"

  steps:
    step_1_parse_input:
      action: "Extract task description from user input"
      validation: "Task description must not be empty"
      on_failure: "Use AskUserQuestion to clarify task"
      error_message: "STATUS=FAIL ERROR='Task description required'"

    step_2_state_understanding:
      action: "Clearly articulate what the task requires"
      outputs:
      - "Task summary in your own words"
      - "Identified ambiguities needing clarification"
      - "Initial scope assessment"

    step_3_extract_session_id:
      action: "Parse SESSION_ID from input JSON (if available)"
      sanitization: "tr -cd 'a-zA-Z0-9_-'"
      storage: "Store for .spec-active marker usage"
      fallback: "Continue without session isolation (use legacy .spec-active)"

  outputs:
  - task_description
  - task_summary
  - ambiguities_list
  - session_id
  - scope_initial

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 2: SPEC FOLDER SETUP
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_2_spec_folder_setup:
  phase_name: "Spec Folder Setup"
  emoji: "ğŸ“"
  purpose: "Determine which spec folder to use for planning session"
  integration: "Works with workflows-conversation system"

  steps:
    step_4_check_active_folder:
      action: "Look for active spec folder marker"
      markers:
      - ".spec-active.{SESSION_ID} (session-isolated)"
      - ".spec-active (legacy backward compatibility)"
      read_marker: "Get active spec folder path from marker content"

    step_5_if_active_exists:
      condition: "Active spec folder marker found"
      action: "Use the folder path from marker"
      notification: "Continuing in active spec folder: specs/###-name/"
      next_step: "Proceed to step 6 to confirm or create new"

    step_6_if_no_active:
      condition: "No active spec folder marker found"
      action: "This is a new planning session"
      hook_interaction: "The enforce-spec-folder.sh hook will present options (A/B/C/D)"
      wait_for_hook: "Wait for hook to provide spec folder path"
      next_step: "Proceed to step 7 with chosen folder"

    step_7_process_hook_response:
      options:
        option_a:
          name: "Use existing"
          action: "Verify folder exists, confirm to user"
        option_b:
          name: "Create new"
          action: "Execute folder creation, copy templates"
        option_c:
          name: "Update related"
          action: "Navigate to related spec, create subfolder"
        option_d:
          name: "Skip documentation"
          action: "Create .claude/.spec-skip marker, output plan to .claude/plans/ (legacy mode)"

    step_8_store_active_path:
      action: "Write chosen spec folder path to marker"
      markers:
        primary: ".spec-active.{SESSION_ID}"
        fallback: ".spec-active (if SESSION_ID missing)"
      path_format:
        simple: "specs/###-short-name/"
        subfolder: "specs/###-parent/###-subfolder/"

    step_9_verify_readiness:
      checks:
      - "Confirm spec folder directory exists"
      - "Verify write permissions"
      - "Note folder path for Phase 6 plan output"
      - "If Option D: Confirm .claude/plans/ directory exists instead"

  outputs:
  - spec_folder_path
  - spec_folder_type # existing/new/related/skip
  - session_marker_written
  - ready_for_planning

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 3: CONTEXT LOADING
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_3_context_loading:
  phase_name: "Context Loading"
  emoji: "ğŸ§ "
  purpose: "Load previous planning session context when continuing in existing spec folder"

  steps:
    step_10_detect_memory:
      action: "Check for memory/ directory in active spec folder"
      path: "{spec_folder_path}/memory/"
      if_not_found: "Skip to Phase 4 (no previous context)"
      if_found: "List recent memory files (up to 3) with relative timestamps"

    step_11_ask_user_preference:
      tool: "AskUserQuestion"
      question: "Previous planning sessions found. How would you like to proceed?"
      options:
        option_a:
          label: "Load most recent file only"
          description: "Quick context refresh from last session"
          action: "Read most recent memory file"
        option_b:
          label: "Load all recent files (up to 3)"
          description: "Comprehensive context from multiple sessions"
          action: "Read up to 3 recent files (parallel Read calls)"
        option_c:
          label: "List all files and select specific"
          description: "Browse all memory files and choose"
          action: "List up to 10 files, wait for user selection, then read"
        option_d:
          label: "Skip (start fresh without context)"
          description: "Ignore previous sessions and start new"
          action: "Proceed to Phase 4 without loading context"

    step_12_load_memory_files:
      action: "Use Read tool to load selected files"
      optimization: "For Option B: Make parallel Read calls for efficiency"
      integration: "Integrate loaded context into planning session"
      outputs:
      - previous_decisions
      - previous_findings
      - user_feedback_history
      - context_summary

  outputs:
  - memory_loaded # true/false
  - memory_file_count
  - context_integrated
  - previous_session_summary

exploration_philosophy:
  approach: "Hypothesis-driven exploration with verification"
  pattern: "Explore ({AGENT_MODEL} agents) â†’ Verify ({ORCHESTRATOR_MODEL} reasoning)"
  mandate: "Never assume - verify by reading files. Report findings, not conclusions."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 4: PARALLEL EXPLORATION (PARAMETERIZED AGENTS)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_4_parallel_exploration:
  phase_name: "Parallel Exploration ({AGENT_MODEL} Agents)"
  emoji: "ğŸ“Š"
  purpose: "Spawn 4 Explore agents in parallel to discover codebase patterns"
  orchestrator_model: "{ORCHESTRATOR_MODEL}"  # Set by parent command
  agent_model: "{AGENT_MODEL}"  # Set by parent command (typically sonnet)

  steps:
    step_13_spawn_explore_agents:
      action: "Spawn multiple Explore agents in parallel using Task tool"
      tool: "Task"
      parameters:
        subagent_type: "explore"
        model: "{AGENT_MODEL}"  # Use model from parent command

      agents:
        architecture_explorer:
          focus: "Project structure, entry points, component connections"
          purpose: "Understand system architecture"
          model: "{AGENT_MODEL}"
          prompt_template: |
            Explore the codebase to find how the system architecture works.

            Return:
            1. Your hypothesis about the architecture
            2. Full paths to all relevant files (e.g., /path/to/file.ts:lineNumber)
            3. Any patterns you noticed (component structure, module organization, etc.)

            Do NOT draw conclusions - just report findings. The main agent will verify.

        feature_explorer:
          focus: "Similar features, related patterns"
          purpose: "Find reusable patterns"
          model: "{AGENT_MODEL}"
          prompt_template: |
            Explore the codebase to find similar features or related patterns for: {task_description}

            Return:
            1. Your hypothesis about existing similar features
            2. Full paths to all relevant files (e.g., /path/to/file.ts:lineNumber)
            3. Any patterns you noticed (naming conventions, implementation patterns, etc.)

            Do NOT draw conclusions - just report findings. The main agent will verify.

        dependency_explorer:
          focus: "Imports, modules, affected areas"
          purpose: "Identify integration points"
          model: "{AGENT_MODEL}"
          prompt_template: |
            Explore the codebase to find dependencies and integration points for: {task_description}

            Return:
            1. Your hypothesis about which modules/files will be affected
            2. Full paths to all relevant files (e.g., /path/to/file.ts:lineNumber)
            3. Any patterns you noticed (dependency chains, coupling points, etc.)

            Do NOT draw conclusions - just report findings. The main agent will verify.

        test_explorer:
          focus: "Test patterns, testing infrastructure"
          purpose: "Understand verification approach"
          model: "{AGENT_MODEL}"
          prompt_template: |
            Explore the codebase to find test patterns and testing infrastructure.

            Return:
            1. Your hypothesis about how testing works in this project
            2. Full paths to all relevant test files (e.g., /path/to/file.test.ts:lineNumber)
            3. Any patterns you noticed (test frameworks, mocking patterns, coverage expectations, etc.)

            Do NOT draw conclusions - just report findings. The main agent will verify.

    step_14_agent_spawn_requirements:
      important: "OpenCode: Use model parameter from parent command"
      rationale: "Model selection determined by parent command (with_claude, with_gpt, with_gemini)"
      pattern: |
        Task({
          subagent_type: "explore",
          model: "{AGENT_MODEL}",  // From parent command
          description: "Architecture exploration",
          prompt: "[exploration prompt from agent template]"
        })

  outputs:
  - architecture_findings # From Architecture Explorer
  - feature_findings # From Feature Explorer
  - dependency_findings # From Dependency Explorer
  - test_findings # From Test Explorer
  - total_files_identified # Count across all agents
  - hypothesis_list # Unverified hypotheses from all agents

  success_metrics:
  - "4 agents spawn successfully"
  - "All agents complete within timeout"
  - "At least 10-30 files identified total"
  - "Clear hypotheses from each agent"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 5: HYPOTHESIS VERIFICATION (ORCHESTRATOR REVIEW)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_5_hypothesis_verification:
  phase_name: "Hypothesis Verification ({ORCHESTRATOR_MODEL} Review)"
  emoji: "ğŸ”¬"
  purpose: "{ORCHESTRATOR_MODEL} synthesizes and validates agent findings"
  model: "{ORCHESTRATOR_MODEL}"  # Set by parent command

  steps:
    step_15_verify_findings:
      action: "{ORCHESTRATOR_MODEL} reads files and verifies/refutes each hypothesis"
      model: "{ORCHESTRATOR_MODEL}"
      verification_process:
        read_files:
          action: "Read each file identified by {AGENT_MODEL} Explore agents"
          tool: "Read"
          paths: "Use file paths from agent findings (with line numbers)"

        verify_hypotheses:
          action: "Verify or refute each hypothesis with deep reasoning"
          approach:
          - "Cross-check agent findings against actual code"
          - "Identify contradictions or gaps in agent hypotheses"
          - "Validate architectural assumptions"
          - "Confirm integration points"

        cross_reference:
          action: "Cross-reference findings across agents for consistency"
          checks:
          - "Do dependency findings match architecture findings?"
          - "Do test patterns align with implementation patterns?"
          - "Are there conflicting hypotheses between agents?"

        build_mental_model:
          action: "Build complete mental model of:"
          components:
          - current_architecture:
              description: "How the system is currently structured"
              verified_patterns: "Architectural patterns confirmed by file reading"
          - affected_components:
              description: "Which parts will be modified for this task"
              impact_assessment: "Extent of changes required"
          - integration_points:
              description: "Where new code connects to existing code"
              dependency_verification: "Confirmed dependencies and imports"
          - potential_risks:
              description: "Risks identified during verification"
              risk_mitigation: "How to mitigate identified risks"

        resolve_conflicts:
          action: "Resolve any conflicting hypotheses from different agents"
          approach:
          - "Read additional files if needed to clarify"
          - "Prioritize evidence over assumptions"
          - "Document unresolved ambiguities for user clarification"

  outputs:
  - verified_architecture # Confirmed architectural understanding
  - verified_patterns # Confirmed reusable patterns
  - verified_dependencies # Confirmed integration points
  - verified_test_approach # Confirmed testing strategy
  - conflicting_hypotheses # Unresolved conflicts needing clarification
  - mental_model_complete # Complete understanding of task context
  - risk_assessment # Identified risks and mitigations

  success_metrics:
  - "All agent hypotheses verified or refuted"
  - "Mental model includes all 4 components (architecture, affected, integration, risks)"
  - "Conflicting hypotheses resolved or documented"
  - "At least 80% of identified files actually read for verification"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 6: DOCUMENT CREATION (SpecKit Aligned)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_6_document_creation:
  phase_name: "Document Creation (SpecKit)"
  emoji: "ğŸ“"
  purpose: "Generate level-appropriate SpecKit documentation using templates"
  mode: "simple"
  output: "Level 1: spec.md + plan.md + tasks.md | Level 2: +checklist.md | Level 3: +decision-record.md"
  mandatory: "MUST create spec.md FIRST per AGENTS.md Section 2"

  level_outputs:
    level_1:
      required: ["spec.md", "plan.md", "tasks.md"]
      optional: []
    level_2:
      required: ["spec.md", "plan.md", "tasks.md", "checklist.md"]
      optional: []
    level_3:
      required: ["spec.md", "plan.md", "tasks.md", "checklist.md", "decision-record.md"]
      optional: ["research-spike.md"]

  steps:
    step_16_create_spec_md:
      description: "STEP 1: Create spec.md (MANDATORY for ALL levels)"
      action: "Create spec.md at {spec_folder_path}/spec.md"
      priority: "MUST create spec.md FIRST per AGENTS.md Section 2"

      template_usage:
        read_template:
          path: ".opencode/speckit/templates/spec.md"
          purpose: "Feature specification - requirements and user stories"
          requirement: "Use as skeleton, preserve all section headings"

        fill_placeholders:
          pattern: "[YOUR_VALUE_HERE: ...]"
          action: "Replace with actual content from task understanding"
          sources:
          - "Phase 1 task understanding"
          - "Phase 0 documentation level"
          - "Phase 3 loaded context (if any)"

        remove_samples:
          pattern: "[PLACEHOLDER]"
          action: "Replace with actual content"
          requirement: "No placeholder text remaining"

      content_population:
        section_1_objective:
          heading: "## 1. OBJECTIVE"
          sources:
          - "Task description from Phase 1"
          - "Documentation level from Phase 0"
          content:
          - "Fill metadata (Category, Tags, Priority, Branch, Date, Status, Input)"
          - "List stakeholders (Product, Engineering, Design, QA, etc.)"
          - "Define purpose (one-sentence outcome statement)"
          - "Document assumptions with clarification questions"

        section_2_scope:
          heading: "## 2. SCOPE"
          sources:
          - "Task understanding from Phase 1"
          content:
          - "List in-scope deliverables (specific, concrete)"
          - "List out-of-scope items with reasons"

        section_3_users_stories:
          heading: "## 3. USERS & STORIES"
          sources:
          - "Task description from Phase 1"
          content:
          - "Create prioritized user stories (P0/P1/P2/P3)"
          - "Each story independently testable"
          - "Include acceptance scenarios (Given/When/Then)"
          - "Explain priority rationale"

        section_4_functional_requirements:
          heading: "## 4. FUNCTIONAL REQUIREMENTS"
          content:
          - "List testable functional requirements (FR-001, FR-002, etc.)"
          - "Use MUST/SHALL for requirements"
          - "Create traceability mapping to user stories"

        section_5_non_functional_requirements:
          heading: "## 5. NON-FUNCTIONAL REQUIREMENTS"
          content:
          - "Performance requirements (response time, throughput, concurrency)"
          - "Security requirements (auth, encryption, compliance)"
          - "Reliability requirements (uptime, error rate, recovery)"
          - "Usability requirements (accessibility, browser support, mobile)"
          - "Operability requirements (monitoring, deployment, logging)"

        section_6_edge_cases:
          heading: "## 6. EDGE CASES"
          content:
          - "Data boundaries (empty input, max length, special chars)"
          - "Error scenarios (API failures, timeouts, concurrent updates)"
          - "State transitions (partial completion, rollback, session expiry)"

        section_7_success_criteria:
          heading: "## 7. SUCCESS CRITERIA"
          content:
          - "Measurable outcomes (completion time, performance, success rate)"
          - "KPI targets (adoption, quality, performance, reliability)"

        section_8_dependencies_risks:
          heading: "## 8. DEPENDENCIES & RISKS"
          content:
          - "List dependencies (systems, APIs, libraries) with status"
          - "Risk assessment with mitigation strategies"
          - "Rollback plan"

        section_9_out_of_scope:
          heading: "## 9. OUT OF SCOPE"
          content:
          - "Explicit exclusions to prevent scope creep"

        section_10_open_questions:
          heading: "## 10. OPEN QUESTIONS"
          content:
          - "List questions needing clarification from stakeholders"

        section_11_appendix:
          heading: "## 11. APPENDIX"
          content:
          - "References (related specs, design mockups, API docs)"
          - "Diagrams (architecture, flowcharts, data models)"

      validation:
      - "NO placeholder text remaining ([YOUR_VALUE_HERE:], [PLACEHOLDER])"
      - "All [NEEDS CLARIFICATION:] either filled or kept as open questions"
      - "User stories have priorities and independent test descriptions"
      - "All template sections present and filled"

    step_17_create_plan_md:
      description: "STEP 2: Create plan.md (MANDATORY for Level 2+)"
      action: "Create plan.md at {spec_folder_path}/plan.md"
      note: "Technical implementation plan with exploration findings"

      template_usage:
        read_template:
          path: ".opencode/speckit/templates/plan.md"
          purpose: "Technical approach and architecture"
          requirement: "Use as skeleton, preserve all section headings"

        fill_placeholders:
          pattern: "[YOUR_VALUE_HERE: ...]"
          action: "Replace with actual content from exploration findings"
          sources:
          - "Phases 4-5 exploration and verification"
          - "Phase 1 task understanding"
          - "Phase 0 documentation level"
          - "Spec.md created in step_16"

        remove_samples:
          pattern: "[PLACEHOLDER]"
          action: "Replace with actual content"
          requirement: "No placeholder text remaining"

      content_population:
        section_1_objective:
          heading: "## 1. OBJECTIVE"
          sources:
          - "Task description from Phase 1"
          - "Verified findings from Phase 5"
          - "spec.md objective"
          content:
          - "Synthesize task and findings into technical objective"
          - "Include metadata: Category, Tags, Priority, Branch, Date, Spec link"
          - "Define technical context (language, dependencies, platform)"

        section_2_quality_gates:
          heading: "## 2. QUALITY GATES"
          sources:
          - "Test Explorer findings from Phase 4"
          - "Verification strategy from Phase 5"
          content:
          - "Definition of Ready (DoR) and Definition of Done (DoD)"
          - "Rollback guardrails and recovery procedures"

        section_3_project_structure:
          heading: "## 3. PROJECT STRUCTURE"
          sources:
          - "Architecture Explorer findings from Phase 4"
          - "Verified architecture from Phase 5"
          content:
          - "Document affected areas from Architecture Explorer"
          - "Show directory structure for modified files"

        section_4_implementation_phases:
          heading: "## 4. IMPLEMENTATION PHASES"
          sources:
          - "All Explore agent findings from Phase 4"
          - "Verified integration points from Phase 5"
          content:
          - "Break down solution into implementation phases"
          - "Include file paths with line numbers (path/to/file.ts:123)"
          - "Reference verified integration points"
          - "Add test patterns"

        section_5_testing_strategy:
          heading: "## 5. TESTING STRATEGY"
          sources:
          - "Test Explorer findings from Phase 4"
          content:
          - "Test pyramid (unit/integration/e2e)"
          - "Test coverage targets"
          - "CI quality gates"

        section_6_success_metrics:
          heading: "## 6. SUCCESS METRICS"
          content:
          - "Measurable outcomes (functional, performance, quality)"

        section_7_risks_mitigations:
          heading: "## 7. RISKS & MITIGATIONS"
          sources:
          - "Risk assessment from Phase 5"
          content:
          - "Risk matrix with mitigations"
          - "Rollback plan"

        section_8_dependencies:
          heading: "## 8. DEPENDENCIES"
          sources:
          - "Dependency Explorer findings from Phase 4"
          content:
          - "Internal and external dependencies"

        section_9_communication:
          heading: "## 9. COMMUNICATION & REVIEW"
          content:
          - "Review checkpoints and stakeholder communication"

        section_10_references:
          heading: "## 10. REFERENCES"
          content:
          - "Link to spec.md and agent findings"

      validation:
      - "NO placeholder text remaining"
      - "All file paths include line numbers"
      - "References spec.md in section 10"

      final_line:
        content: |
          ---
          **USER: Please review spec.md and plan.md. Edit any section directly, then confirm to proceed.**

    step_18_create_tasks_md:
      description: "STEP 3: Create tasks.md (ALL LEVELS - part of baseline)"
      condition: "Execute for ALL documentation levels (1, 2, 3)"
      action: "Create tasks.md at {spec_folder_path}/tasks.md"
      note: "Task breakdown is now part of baseline documentation"

      template_usage:
        read_template:
          path: ".opencode/speckit/templates/tasks.md"
          purpose: "Implementation task list organized by user story"
          requirement: "Use as skeleton, preserve structure"

        fill_placeholders:
          pattern: "[YOUR_VALUE_HERE: ...]"
          action: "Replace with task breakdown from plan.md"
          sources:
          - "plan.md implementation phases (step_17)"
          - "spec.md user stories (step_16)"

      content_population:
        tasks_by_user_story:
          action: "Break plan phases into actionable tasks"
          organization: "Group by user story from spec.md"
          format: "- [ ] Task description (estimated time, file references)"
          priority: "Inherit from user story priority"

      validation:
      - "Tasks traceable to user stories in spec.md"
      - "Each task has checkbox, description, estimate"
      - "File paths included where applicable"

    step_19_create_checklist_md:
      description: "STEP 4: Create checklist.md (Level 2+ ONLY)"
      condition: "Execute if documentation_level >= 2"
      action: "Create checklist.md at {spec_folder_path}/checklist.md"
      note: "Verification checklist for quality assurance"

      template_usage:
        read_template:
          path: ".opencode/speckit/templates/checklist.md"
          purpose: "Verification checklist for testing and QA"
          requirement: "Use as skeleton, preserve structure"

        fill_placeholders:
          pattern: "[YOUR_VALUE_HERE: ...]"
          action: "Replace with verification items from spec.md and plan.md"
          sources:
          - "spec.md acceptance criteria"
          - "plan.md testing strategy"
          - "tasks.md completion criteria"

      content_population:
        checklist_items:
          action: "Create verification checklist items"
          categories:
          - "Pre-implementation checks"
          - "Implementation verification"
          - "Testing checklist"
          - "Post-implementation validation"
          format: "- [ ] Verification item (requirement reference)"

      validation:
      - "Checklist items traceable to requirements"
      - "All acceptance criteria covered"
      - "Testing items align with plan.md strategy"

    step_20_create_decision_record_md:
      description: "STEP 5: Create decision-record.md (Level 3 ONLY)"
      condition: "Execute if documentation_level == 3"
      action: "Create decision-record.md at {spec_folder_path}/decision-record.md"
      note: "Architecture Decision Record for complex/architectural tasks"

      template_usage:
        read_template:
          path: ".opencode/speckit/templates/decision-record.md"
          purpose: "Document architectural decisions and rationale"
          requirement: "Use as skeleton, preserve ADR structure"

        fill_placeholders:
          pattern: "[YOUR_VALUE_HERE: ...]"
          action: "Replace with decisions from exploration findings"
          sources:
          - "Phase 5 verified architecture findings"
          - "Phase 5 risk assessment"
          - "User feedback from Phase 7 (if revision)"

      content_population:
        adr_sections:
          action: "Document key architectural decisions"
          structure:
          - "Context: Why this decision was needed"
          - "Decision: What was decided"
          - "Consequences: Impact and trade-offs"
          - "Alternatives: Options considered and rejected"

      validation:
      - "All major architectural decisions documented"
      - "Trade-offs clearly explained"
      - "Alternatives listed with rejection rationale"

    step_21_create_research_spike_md:
      description: "STEP 6: Create research-spike.md (Level 3 OPTIONAL)"
      condition: "Execute if documentation_level == 3 AND research_needed"
      action: "Create research-spike.md at {spec_folder_path}/research-spike.md"
      note: "Optional research documentation for technical spikes"
      optional: true

      template_usage:
        read_template:
          path: ".opencode/speckit/templates/research-spike.md"
          purpose: "Document technical research and findings"
          requirement: "Use as skeleton if research conducted"

      trigger_conditions:
      - "Exploration agents identified unknown technologies"
      - "Task involves POC or feasibility assessment"
      - "User explicitly requested research documentation"

  outputs:
  - spec_file_path: "{spec_folder_path}/spec.md"
  - plan_file_path: "{spec_folder_path}/plan.md"
  - tasks_file_path: "{spec_folder_path}/tasks.md"
  - checklist_file_path: "{spec_folder_path}/checklist.md (Level 2+)"
  - decision_record_file_path: "{spec_folder_path}/decision-record.md (Level 3)"
  - research_spike_file_path: "{spec_folder_path}/research-spike.md (Level 3, optional)"
  - documentation_level: "1, 2, or 3"
  - files_created: "Level-appropriate files per progressive enhancement"
  - template_validated: true
  - placeholders_removed: true

# PHASE 7: USER REVIEW & CONFIRMATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_7_user_review:
  phase_name: "User Review & Confirmation"
  emoji: "ğŸ‘¤"
  purpose: "Request approval, wait for edits, re-read all documents after confirmation"

  steps:
    step_22_request_approval:
      action: "Inform user that SpecKit documents have been created"
      notification_format: |
        SpecKit Documentation Created (Level {documentation_level}):
        - spec.md - Feature specification and requirements
        - plan.md - Technical implementation plan
        - tasks.md - Task breakdown
        {- checklist.md - Verification checklist (Level 2+)}
        {- decision-record.md - Decision documentation (Level 3)}
        {- research-spike.md - Research documentation (Level 3, if created)}

        Location: {spec_folder_path}/

        Please review the documentation and confirm to proceed.
        Options:
          - Review and edit files directly
          - Reply "confirm" to proceed with implementation
          - Reply "cancel" to abort

      wait_for: "Explicit confirmation (confirm or cancel)"
      blocking: "DO NOT write implementation files until confirmed"

    step_23_handle_response:
      on_confirm:
        action: "Proceed to step 24 (re-read documents)"
      on_reject:
        action: "Set STATUS=CANCELLED ACTION=user_rejected"
        capture: "REASON=[reason from user]"

    step_24_reread_documents:
      purpose: "User may have edited any of the documentation files"
      action: "Re-read all created documents based on documentation level"
      tool: "Read (parallel calls for efficiency)"
      files:
        level_1:
          - path: "{spec_folder_path}/spec.md"
            required: true
          - path: "{spec_folder_path}/plan.md"
            required: true
          - path: "{spec_folder_path}/tasks.md"
            required: true
        level_2:
          - path: "{spec_folder_path}/checklist.md"
            required: true
        level_3:
          - path: "{spec_folder_path}/decision-record.md"
            required: true
          - path: "{spec_folder_path}/research-spike.md"
            required: false
      analysis:
      - "Note any changes the user made to any file"
      - "Acknowledge the changes before proceeding"
      - "Begin implementation following spec.md and plan.md exactly"

    step_25_return_status:
      on_awaiting_review:
        status_level_1: "STATUS=OK ACTION=documentation_created FILES=spec.md,plan.md,tasks.md PATH={spec_folder_path}/"
        status_level_2: "STATUS=OK ACTION=documentation_created FILES=spec.md,plan.md,tasks.md,checklist.md PATH={spec_folder_path}/"
        status_level_3: "STATUS=OK ACTION=documentation_created FILES=spec.md,plan.md,tasks.md,checklist.md,decision-record.md PATH={spec_folder_path}/"
      on_rejected:
        status: "STATUS=CANCELLED ACTION=user_rejected REASON=[reason]"

  outputs:
  - user_decision # confirmed/rejected
  - documents_edited # true/false
  - spec_final_content
  - plan_final_content
  - tasks_final_content
  - checklist_final_content # if Level 2+
  - decision_record_final_content # if Level 3
  - ready_for_implementation

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 8: CONTEXT PERSISTENCE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_8_context_persistence:
  phase_name: "Context Persistence"
  emoji: "ğŸ’¾"
  purpose: "Save planning session context to memory/ for future sessions"

  steps:
    step_23_invoke_save_context_skill:
      description: "Invoke workflows-save-context skill for anchor-based memory"
      action: "Use Skill tool to create memory file with anchor tags"

      skill_invocation:
        tool: Skill
        parameter: skill="workflows-save-context"
        note: |
          The workflows-save-context skill will:
          - Read context_template.md (includes anchor tag structure)
          - Auto-generate anchor IDs from section titles
          - Create task-forward structure (Implementation Guide first)
          - Save to {spec_folder_path}/memory/DD-MM-YY_HH-MM__topic.md
          - Enable grep-based retrieval: grep -r "anchor:.*keyword" memory/

        benefits:
        - "Anchor tags enable task-oriented context retrieval"
        - "Consistent format with spec_kit workflows"
        - "Single source of truth (context_template.md)"
        - "Grep-able sections for future sessions"

        fallback:
          on_failure: "Use legacy inline template (step_24_legacy_template)"
          reason: "Graceful degradation if skill unavailable"

    step_24_legacy_template:
      description: "FALLBACK ONLY - Legacy memory file format (no anchors)"
      condition: "Only execute if skill invocation fails"

      action: "Create memory file using inline template"
      path: "{spec_folder_path}/memory/DD-MM-YY_HH-MM__topic.md"

      template: |
        # Planning Session: {task_description}
        **Date**: {timestamp}
        **Spec Folder**: {spec_folder_path}

        âš ï¸ Note: Created with legacy template (no anchor tags)

        ## Session Summary
        {planning_summary}

        ## Key Decisions
        - Mode: {selected_mode}
        - Architectural choices: {arch_decisions}
        - Technology decisions: {tech_decisions}

        ## Exploration Findings

        **Architecture Explorer**:
        {architecture_findings}

        **Feature Explorer**:
        {feature_findings}

        **Dependency Explorer**:
        {dependency_findings}

        **Test Explorer**:
        {test_findings}

        ## User Feedback
        {user_feedback}

  outputs:
  - memory_file_created
  - memory_file_path
  - context_saved
  - anchors_generated  # true if skill used, false if fallback

# SIMPLE MODE CHARACTERISTICS (SpecKit Aligned)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
simple_mode_features:
  file_output:
    type: "Multi-file SpecKit documentation (Progressive Enhancement)"
    files:
      spec_md:
        path: "{spec_folder_path}/spec.md"
        template: "spec.md"
        size: "300-1000 lines (requirements, user stories)"
        level: "ALL (baseline)"
      plan_md:
        path: "{spec_folder_path}/plan.md"
        template: "plan.md"
        size: "500-2000 lines (technical approach)"
        level: "ALL (baseline)"
      tasks_md:
        path: "{spec_folder_path}/tasks.md"
        template: "tasks.md"
        size: "200-500 lines (task breakdown)"
        level: "ALL (baseline)"
      checklist_md:
        path: "{spec_folder_path}/checklist.md"
        template: "checklist.md"
        size: "50-200 lines (verification checklist)"
        level: "Level 2+"
      decision_record_md:
        path: "{spec_folder_path}/decision-record.md"
        template: "decision-record.md"
        size: "100-400 lines (ADR)"
        level: "Level 3"
      research_spike_md:
        path: "{spec_folder_path}/research-spike.md"
        template: "research-spike.md"
        size: "100-500 lines (research documentation)"
        level: "Level 3 (optional)"

  structure:
    level_1: "spec.md + plan.md + tasks.md (Baseline)"
    level_2: "Level 1 + checklist.md (Verification)"
    level_3: "Level 2 + decision-record.md + optional research-spike.md (Full)"
    templates: ".opencode/speckit/templates/"
    sections_spec: 11
    sections_plan: 10

  loc_thresholds:
    note: "SOFT GUIDANCE - hooks enforce HARD requirements"
    level_1: "<100 LOC suggests Level 1"
    level_2: "100-499 LOC suggests Level 2"
    level_3: ">=500 LOC suggests Level 3"

  target_features:
    level_1: "Simple tasks, bug fixes, small enhancements"
    level_2: "Features needing verification, medium complexity"
    level_3: "Complex features, architecture changes, high-risk modifications"

  advantages:
  - "Progressive enhancement - start with baseline, add as needed"
  - "Separation of concerns (requirements vs technical approach vs verification)"
  - "Aligned with AGENTS.md Section 2 requirements"
  - "Supports workflows-spec-kit enforcement with HARD hooks"
  - "Task breakdown for ALL tasks (part of baseline)"
  - "Verification checklist for quality assurance (Level 2+)"
  - "Decision documentation for architectural choices (Level 3)"

  when_to_use:
  - "Level 1: Simple tasks, bug fixes, small features (<100 LOC)"
  - "Level 2: Features needing verification, testing, QA review (100-499 LOC)"
  - "Level 3: Architecture changes, complex features, high-risk (>=500 LOC)"
  - "Any task running plan command (implies need for Level 1 minimum)"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# TEMPLATE VALIDATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
template_validation:
  pre_write_checks:
  - check: "All [YOUR_VALUE_HERE:] placeholders filled"
    tool: "String search"
    action_if_found: "Fill from exploration findings or mark for user input"

  - check: "All [PLACEHOLDER] markers removed"
    tool: "String search"
    action_if_found: "Replace with actual content"

  - check: "All [NEEDS CLARIFICATION:] resolved"
    tool: "String search"
    action_if_found: "Either fill with best judgment or keep as open question"

  - check: "File paths include line numbers"
    pattern: "path/to/file.ext:NNN"
    action_if_missing: "Add line numbers from agent findings"

  post_write_validation:
  - check: "Template source marker present"
    marker: "<!-- SPECKIT_TEMPLATE_SOURCE: plan | v1.0 -->"
    action_if_missing: "Add marker at top of file"

  - check: "All 10 sections present"
    sections:
    - "OBJECTIVE"
    - "QUALITY GATES"
    - "PROJECT STRUCTURE"
    - "IMPLEMENTATION PHASES"
    - "TESTING STRATEGY"
    - "SUCCESS METRICS"
    - "RISKS & MITIGATIONS"
    - "DEPENDENCIES"
    - "COMMUNICATION & REVIEW"
    - "REFERENCES"
    action_if_missing: "Add missing section with placeholder note"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# COMPLETION CRITERIA (SpecKit Aligned)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
simple_mode_completion:
  documentation_created: true
  speckit_compliant: true
  findings_integrated: true
  ready_for_review: true

  verification_checklist:
    level_1_baseline:
    - "spec.md file exists at {spec_folder_path}/spec.md"
    - "plan.md file exists at {spec_folder_path}/plan.md"
    - "tasks.md file exists at {spec_folder_path}/tasks.md"
    level_2_additions:
    - "checklist.md file exists at {spec_folder_path}/checklist.md"
    level_3_additions:
    - "decision-record.md file exists at {spec_folder_path}/decision-record.md"
    - "research-spike.md file exists (optional, if research conducted)"
    all_levels:
    - "All placeholders removed from all files"
    - "Exploration findings integrated into plan.md"
    - "Requirements and user stories documented in spec.md"
    - "Template validation passed for all files"
    - "User review prompt presented for all documents"
    - "Documentation level (1, 2, or 3) correctly determined and applied"
    - "SpecKit template sources referenced in all files"
    - "Progressive enhancement: higher levels include all lower level files"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ERROR HANDLING
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
error_handling:
  template_not_found:
    action: "Use inline template structure as fallback"
    notification: "Template file missing at .opencode/speckit/templates/plan.md"

  placeholder_filling_incomplete:
    action: "Mark remaining placeholders as [NEEDS CLARIFICATION: user input required]"
    notification: "Some placeholders could not be filled from exploration findings"

  write_permission_denied:
    action: "Return plan content in chat"
    notification: "Cannot write to {spec_folder_path}/plan.md - permission denied"
    fallback: "Suggest manual file creation"

  exploration_findings_insufficient:
    action: "Fill sections with [INSUFFICIENT DATA: user input required]"
    notification: "Exploration did not find enough information for complete plan"
    recommendation: "User should clarify requirements or provide more context"
