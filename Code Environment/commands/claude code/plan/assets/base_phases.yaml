# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PLAN: BASE PHASES (MODEL-AGNOSTIC, SHARED ACROSS MODES)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
role: Expert Planning Orchestrator
purpose: Pre-planning setup, context loading, user review, and context persistence
action: Execute Phases 1-3 (setup) and Phases 7-8 (review & persistence)

operating_mode:
  workflow: sequential_shared_phases
  workflow_compliance: MANDATORY
  workflow_execution: autonomous_with_user_review
  approvals: user_confirmation_phase_7
  tracking: phase_progress
  validation: speckit_folder_compliance

component_info:
  phases_included: "1-3 (Setup), 7-8 (Review & Persistence)"
  phases_excluded: "4-5 (Exploration) - see exploration.yaml or exploration_opus.yaml"
  model_agnostic: true
  reusable_by: "simple_mode.yaml (parameterized for sonnet/opus), complex_mode.yaml"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 1: TASK UNDERSTANDING & SESSION INITIALIZATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_1_task_understanding:
  phase_name: "Task Understanding & Session Initialization"
  emoji: "ğŸ“‹"
  purpose: "Parse input, validate task description, extract SESSION_ID"

  steps:
    step_1_parse_input:
      action: "Extract task description from user input"
      validation: "Task description must not be empty"
      on_failure: "Use AskUserQuestion to clarify task"
      error_message: "STATUS=FAIL ERROR='Task description required'"

    step_2_state_understanding:
      action: "Clearly articulate what the task requires"
      outputs:
      - "Task summary in your own words"
      - "Identified ambiguities needing clarification"
      - "Initial scope assessment"

    step_3_extract_session_id:
      action: "Parse SESSION_ID from input JSON (if available)"
      sanitization: "tr -cd 'a-zA-Z0-9_-'"
      storage: "Store for .spec-active marker usage"
      fallback: "Continue without session isolation (use legacy .spec-active)"

  outputs:
  - task_description
  - task_summary
  - ambiguities_list
  - session_id
  - scope_initial

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 2: SPEC FOLDER SETUP
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_2_spec_folder_setup:
  phase_name: "Spec Folder Setup"
  emoji: "ğŸ“"
  purpose: "Determine which spec folder to use for planning session"
  integration: "Works with workflows-conversation system"

  steps:
    step_4_check_active_folder:
      action: "Look for active spec folder marker"
      markers:
      - ".spec-active.{SESSION_ID} (session-isolated)"
      - ".spec-active (legacy backward compatibility)"
      read_marker: "Get active spec folder path from marker content"

    step_5_if_active_exists:
      condition: "Active spec folder marker found"
      action: "Use the folder path from marker"
      notification: "Continuing in active spec folder: specs/###-name/"
      next_step: "Proceed to step 6 to confirm or create new"

    step_6_if_no_active:
      condition: "No active spec folder marker found"
      action: "This is a new planning session"
      hook_interaction: "The enforce-spec-folder.sh hook will present options (A/B/C/D)"
      wait_for_hook: "Wait for hook to provide spec folder path"
      next_step: "Proceed to step 7 with chosen folder"

    step_7_process_hook_response:
      options:
        option_a:
          name: "Use existing"
          action: "Verify folder exists, confirm to user"
        option_b:
          name: "Create new"
          action: "Execute folder creation, copy templates"
        option_c:
          name: "Update related"
          action: "Navigate to related spec, create subfolder"
        option_d:
          name: "Skip documentation"
          action: "Create .claude/.spec-skip marker, output plan to .claude/plans/ (legacy mode)"

    step_8_store_active_path:
      action: "Write chosen spec folder path to marker"
      markers:
        primary: ".spec-active.{SESSION_ID}"
        fallback: ".spec-active (if SESSION_ID missing)"
      path_format:
        simple: "specs/###-short-name/"
        subfolder: "specs/###-parent/###-subfolder/"

    step_9_verify_readiness:
      checks:
      - "Confirm spec folder directory exists"
      - "Verify write permissions"
      - "Note folder path for Phase 6 plan output"
      - "If Option D: Confirm .claude/plans/ directory exists instead"

  outputs:
  - spec_folder_path
  - spec_folder_type # existing/new/related/skip
  - session_marker_written
  - ready_for_planning

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 3: CONTEXT LOADING
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_3_context_loading:
  phase_name: "Context Loading"
  emoji: "ğŸ§ "
  purpose: "Load previous planning session context when continuing in existing spec folder"

  steps:
    step_10_detect_memory:
      action: "Check for memory/ directory in active spec folder"
      path: "{spec_folder_path}/memory/"
      if_not_found: "Skip to Phase 4 (no previous context)"
      if_found: "List recent memory files (up to 3) with relative timestamps"

    step_11_ask_user_preference:
      tool: "AskUserQuestion"
      question: "Previous planning sessions found. How would you like to proceed?"
      options:
        option_a:
          label: "Load most recent file only"
          description: "Quick context refresh from last session"
          action: "Read most recent memory file"
        option_b:
          label: "Load all recent files (up to 3)"
          description: "Comprehensive context from multiple sessions"
          action: "Read up to 3 recent files (parallel Read calls)"
        option_c:
          label: "List all files and select specific"
          description: "Browse all memory files and choose"
          action: "List up to 10 files, wait for user selection, then read"
        option_d:
          label: "Skip (start fresh without context)"
          description: "Ignore previous sessions and start new"
          action: "Proceed to Phase 4 without loading context"

    step_12_load_memory_files:
      action: "Use Read tool to load selected files"
      optimization: "For Option B: Make parallel Read calls for efficiency"
      integration: "Integrate loaded context into planning session"
      outputs:
      - previous_decisions
      - previous_findings
      - user_feedback_history
      - context_summary

  outputs:
  - memory_loaded # true/false
  - memory_file_count
  - context_integrated
  - previous_session_summary

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 7: USER REVIEW & CONFIRMATION
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_7_user_review:
  phase_name: "User Review & Confirmation"
  emoji: "ğŸ‘¤"
  purpose: "Request approval, wait for edits, re-read plan after user confirmation"

  steps:
    step_17_request_approval:
      action: "Inform user plan has been created"
      notification_format: |
        Plan created at: {spec_folder_path}/plan.md

        Please review the plan and confirm to proceed.
        Options:
          - Review and edit the file directly
          - Reply "confirm" to proceed with implementation
          - Reply "cancel" to abort
      wait_for: "Explicit confirmation (confirm or cancel)"
      blocking: "DO NOT write implementation files until confirmed"

    step_18_handle_response:
      on_confirm:
        action: "Proceed to step 19 (re-read plan)"
      on_reject:
        action: "Set STATUS=CANCELLED ACTION=user_rejected"
        capture: "REASON=[reason from user]"

    step_19_reread_plan:
      purpose: "User may have edited the plan file"
      action: "Re-read the plan file completely"
      tool: "Read"
      path: "{spec_folder_path}/plan.md"
      analysis:
      - "Note any changes the user made"
      - "Acknowledge the changes before proceeding"
      - "Begin implementation following the plan exactly"

    step_20_return_status:
      on_awaiting_review:
        status: "STATUS=OK ACTION=plan_created PATH={spec_folder_path}/plan.md"
      on_rejected:
        status: "STATUS=CANCELLED ACTION=user_rejected REASON=[reason]"

  outputs:
  - user_decision # confirmed/rejected
  - plan_edited # true/false
  - plan_final_content
  - ready_for_implementation

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PHASE 8: CONTEXT PERSISTENCE
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
phase_8_context_persistence:
  phase_name: "Context Persistence"
  emoji: "ğŸ’¾"
  purpose: "Save planning session context to memory/ for future sessions"

  steps:
    step_21_save_context:
      action: "Create memory file in spec folder"
      path: "{spec_folder_path}/memory/DD-MM-YY_HH-MM__topic.md"
      topic_generation:
        source: "Task description"
        transformation: "lowercase, hyphens, max 30 chars"
        pattern: "sed 's/\\s\\+/-/g; s/[^a-z0-9-]//g' | tr '[:upper:]' '[:lower:]' | cut -c1-30"

      content_structure:
        header:
        - "# Planning Session: [Task Description]"
        - "**Date**: YYYY-MM-DD HH:MM"
        - "**Spec Folder**: {spec_folder_path}"

        session_summary:
          heading: "## Session Summary"
          content: "Brief summary of what was planned"

        key_decisions:
          heading: "## Key Decisions"
          content:
          - "Mode selected (if applicable)"
          - "Architectural choices"
          - "Technology decisions"

        exploration_findings:
          heading: "## Exploration Findings"
          content:
          - "Summary from Architecture Explorer"
          - "Summary from Feature Explorer"
          - "Summary from Dependency Explorer"
          - "Summary from Test Explorer"

        user_feedback:
          heading: "## User Feedback"
          content: "Any edits or feedback user provided during planning"

    step_22_memory_file_format:
      template: |
        # Planning Session: {task_description}
        **Date**: {timestamp}
        **Spec Folder**: {spec_folder_path}

        ## Session Summary
        {planning_summary}

        ## Key Decisions
        - {decision_1}
        - {decision_2}
        ...

        ## Exploration Findings
        - {finding_1}
        - {finding_2}
        ...

        ## User Feedback
        - {feedback_1}
        ...

  outputs:
  - memory_file_created
  - memory_file_path
  - context_saved

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# COMPLETION CRITERIA
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
completion_criteria:
  phase_1_complete:
  - task_description_validated
  - session_id_extracted
  - scope_understood

  phase_2_complete:
  - spec_folder_determined
  - marker_written
  - folder_verified

  phase_3_complete:
  - memory_checked
  - context_loaded_or_skipped

  phase_7_complete:
  - user_reviewed_plan
  - plan_reread_if_edited
  - decision_captured

  phase_8_complete:
  - memory_file_created
  - context_preserved

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ERROR HANDLING
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
error_handling:
  empty_task_description:
    action: "Use AskUserQuestion to clarify"
    retry: true
    max_retries: 3

  spec_folder_not_found:
    action: "Verify path, attempt recovery"
    fallback: "Create new spec folder"

  memory_file_read_error:
    action: "Log warning, proceed without context"
    notification: "Unable to load memory files, starting fresh"

  user_cancels_review:
    action: "Set STATUS=CANCELLED"
    cleanup: "Preserve partial work in spec folder"

  memory_write_failure:
    action: "Log error, notify user"
    impact: "Context not saved for future sessions"
    fallback: "Continue with planning complete"
