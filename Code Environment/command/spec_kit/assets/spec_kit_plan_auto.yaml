# ───────────────────────────────────────────────────────────────────
# SMART SPECKIT: PLAN WORKFLOW (AUTONOMOUS MODE)
# ───────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for autonomous planning
purpose: Spec-driven planning with autonomous execution through step 7
action: Run SpecKit from spec to planning with continuous self-validation

operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: none
  tracking: progressive_task_checklists
  validation: continuous_self_validation

planning_philosophy:
  principle: "Clarity first, completeness second"
  approach: "Thorough analysis with iterative refinement"
  mandate: "Define requirements, validate assumptions, plan incrementally, execute autonomously"

# ───────────────────────────────────────────────────────────────────
# USER INPUTS (Transformed from raw text)
# ───────────────────────────────────────────────────────────────────
user_inputs:
  git_branch: |
    [GIT_BRANCH]
    Git branch name for the work. Leave empty to auto-create as feature-{NNN}.

  spec_folder: |
    [SPEC_FOLDER]
    Spec folder path. Leave empty to auto-create next available spec number.

  context: |
    [CONTEXT]
    Background information, constraints, or existing documentation.

  issues: |
    [ISSUES]
    Known issues, problems, or concerns to address.

  request: |
    [REQUEST]
    Feature or improvement to plan. REQUIRED.

  environment: |
    [STAGING LINK]
    Staging or production URL for browser testing.

  scope: |
    [FILES]
    Files or folders to focus on.

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "spec_folder path using pattern specs/{NNN} or specs/{NNN-name}"
    fallback: "Extract numeric portion or use timestamp if extraction fails"

  defaults:
    git_branch_empty: "Auto-create feature-{NNN} from highest +001"
    spec_folder_empty: "Auto-create specs/{NNN} from highest +001"
    context_empty: "Infer from [REQUEST], [STAGING LINK], and codebase exploration"
    issues_empty: "Investigate and discover during workflow"
    environment_empty: "Skip browser testing steps"
    scope_empty: "Use scope_policy.default"

  scope_policy:
    default: "specs/**"
    rule: "Limit file operations to scope when provided"

# ─────────────────────────────────────────────────────────────────
# DOCUMENTATION LEVELS (Progressive Enhancement)
# ─────────────────────────────────────────────────────────────────
documentation_levels:
  level_1_baseline:
    name: "Level 1 (Baseline)"
    required_files:
    - spec.md
    - plan.md
    - tasks.md
    loc_guidance: "<100 LOC"
    use_case: "Simple changes, bug fixes, minor features"

  level_2_verification:
    name: "Level 2 (Verification)"
    required_files:
    - spec.md
    - plan.md
    - tasks.md
    - checklist.md
    loc_guidance: "100-499 LOC"
    use_case: "Medium features, refactoring, multi-file changes"

  level_3_full:
    name: "Level 3 (Full)"
    required_files:
    - spec.md
    - plan.md
    - tasks.md
    - checklist.md
    - decision-record.md
    optional_files:
    - research-spike.md
    loc_guidance: ">=500 LOC"
    use_case: "Complex features, architecture changes, high-risk modifications"

  level_selection:
    note: "LOC thresholds are SOFT GUIDANCE - choose level based on complexity and risk"
    default: "Level 1 for simple tasks, escalate based on analysis"

# ─────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ─────────────────────────────────────────────────────────────────
available_templates:
  # Level 1+ (Baseline - required at all levels)
  spec: .opencode/speckit/templates/spec.md
  plan: .opencode/speckit/templates/plan.md
  tasks: .opencode/speckit/templates/tasks.md
  # Level 2+ (Verification)
  checklist: .opencode/speckit/templates/checklist.md
  # Level 3 (Full)
  decision_record: .opencode/speckit/templates/decision-record.md
  # Optional (any level)
  research: .opencode/speckit/templates/research.md
  research_spike: .opencode/speckit/templates/research-spike.md
  # Utility (any level)
  handover: .opencode/speckit/templates/handover.md
  debug_delegation: .opencode/speckit/templates/debug-delegation.md

# ─────────────────────────────────────────────────────────────────
# PARALLEL DISPATCH CONFIGURATION (AGENTS.md Compliant)
# ─────────────────────────────────────────────────────────────────
# Smart parallel sub-agent dispatch for eligible workflow phases.
# Uses 5-dimension complexity scoring algorithm.
# Per AGENTS.md Section 1: ALWAYS ask before parallel dispatch (no auto-dispatch)
# Exception: Step 6 Planning exploration is automatic (core planning feature)
parallel_dispatch_config:
  enabled: true
  version: "1.0.0"

  complexity_scoring:
    domain_count:
      weight: 0.35
      domains: [code, analysis, docs, git, testing, devops]
      scoring: "1=0.0, 2=0.5, 3+=1.0"
    file_count:
      weight: 0.25
      scoring: "1-2=0.0, 3-5=0.5, 6+=1.0"
    loc_estimate:
      weight: 0.15
      scoring: "<50=0.0, 50-200=0.5, >200=1.0"
    parallel_opportunity:
      weight: 0.20
      scoring: "sequential=0.0, some=0.5, high=1.0"
    task_type:
      weight: 0.05
      scoring: "trivial=0.0, moderate=0.5, complex=1.0"

  # Decision thresholds (AGENTS.md compliant - no auto-dispatch)
  thresholds:
    direct_max: 20
    ask_min: 20
    min_domains_for_ask: 2
    # NOTE: auto_dispatch_min and min_domains_for_auto REMOVED per AGENTS.md Section 1
    # Always ask user before parallel dispatch (except Step 6 Planning)

  session_preference:
    persist_duration_seconds: 3600

  override_phrases:
    direct: ["proceed directly", "handle directly", "skip parallel", "skip agents"]
    parallel: ["use parallel", "dispatch agents", "parallelize", "use agents"]
    auto: ["auto-decide", "auto mode", "decide for me"]

  question_template:
    method: present_options_to_user
    header: "Parallel Dispatch"
    format: |
      **Phase: {phase_name}**
      Complexity: {complexity_score}% | Domains: {domain_count} ({domains_list})

      This phase may benefit from parallel sub-agents for faster execution.
    options:
      - id: A
        label: "Handle directly"
        description: "Execute phase sequentially without parallel agents"
      - id: B
        label: "Use parallel agents"
        description: "Dispatch specialized agents for faster parallel execution"
      - id: C
        label: "Auto-decide for session"
        description: "Let system decide based on complexity thresholds (1 hour)"

  eligible_phases:
    - step_3_specification
    - step_6_planning  # Has inline_parallel_exploration - 4 agents dispatched directly

# ─────────────────────────────────────────────────────────────────
# WORKFLOW ENFORCEMENT (CRITICAL)
# ─────────────────────────────────────────────────────────────────
workflow_enforcement:
  mode: strict
  step_order: sequential_mandatory
  skip_allowed: false
  
  planning_gate:
    location: "After Step 6"
    purpose: "Verify all planning artifacts complete before context save"
    requirements:
      - "spec.md exists and has no [NEEDS CLARIFICATION] markers"
      - "plan.md exists with technical approach"
    action_if_failed: "STOP and return to incomplete step"
  
  step_completion_rule: |
    FOR EACH STEP:
    1. Execute ALL activities listed
    2. Verify ALL outputs exist
    3. Mark step ✅ in tracking
    4. ONLY THEN proceed to next step
    
    ⛔ NEVER skip a step
    ⛔ NEVER proceed without marking previous step complete
    ⛔ NEVER proceed to implementation without running /spec_kit:implement

  critical_steps:
    step_3_specification:
      enforcement: "MUST create spec.md with all required sections"
      verification: "File exists and contains acceptance criteria"
    step_6_planning:
      enforcement: "MUST create plan.md with technical approach"
      verification: "File exists and contains implementation phases"

# ─────────────────────────────────────────────────────────────────
# WORKFLOW (7 STEPS)
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_request_analysis:
    purpose: Analyze inputs and define planning scope
    activities:
    - Analyze all user inputs thoroughly
    - Define development scope for the spec folder
    - Verify or create spec folder structure
    - Check for existing artifacts
    - Establish planning scope
    deep_analysis:
      focus: comprehensive_requirement_analysis
      outputs:
      - requirement_summary
      - approach_overview
      - complexity_assessment
      - key_objectives
      - success_criteria
    validation: understanding_confirmed

  step_2_pre_work_review:
    purpose: Review skills folder and project standards
    activities:
    - Read and review AGENTS.md
    - Check skills folder (.opencode/skills/) for relevant coding standards
    - Extract coding standards summary
    - Identify architectural patterns
    - Document project conventions
    required_documents:
    - AGENTS.md
    - Skills folder (if available)
    verification: MUST_REVIEW
    validation: principles_established

  step_3_specification:
    purpose: Create comprehensive feature specification

    # PRE-PHASE: Smart parallel dispatch check (AGENTS.md compliant)
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, docs]
      complexity_boost: 0
      decision_logic: |
        BEFORE starting this phase, evaluate parallel dispatch (AGENTS.md compliant):
        1. Check for override phrases in user request
        2. Check for session preference (from previous "Auto-decide" selection)
        3. Check for sequential dependencies (skip if detected)
        4. Calculate phase complexity using parallel_dispatch_config
        5. Apply thresholds:
           - <20% → proceed directly (no parallel agents)
           - ≥20% + 2 domains → ALWAYS ask user
           NOTE: No auto-dispatch - per AGENTS.md Section 1, always ask before parallel dispatch
      on_parallel_dispatch:
        agents:
          - name: "spec_explorer"
            focus: "Existing specifications and patterns in codebase"
            model: "sonnet"
          - name: "requirement_analyzer"
            focus: "Similar features and their requirements"
            model: "sonnet"
        dispatch_note: "Spawn agents in SINGLE message for parallel execution"
      fallback: "Proceed with activities below if dispatch fails or user chooses direct"

    activities:
    - Generate concise short name for branch
    - Check for existing branches
    - Run create-documentation.sh script
    - Estimate complexity and select documentation level using progressive enhancement:
      - "Level 1 (Baseline): <100 LOC - spec.md + plan.md + tasks.md"
      - "Level 2 (Verification): 100-499 LOC - Level 1 + checklist.md"
      - "Level 3 (Full): >=500 LOC - Level 2 + decision-record.md"
    - Load and fill spec.md
    - Generate functional requirements
    - Define success criteria
    outputs:
    - feature_branch: created
    - spec.md: acceptance_criteria
    template: .opencode/speckit/templates/spec.md
    validation: spec_complete

  step_4_clarification:
    purpose: Resolve ambiguities and clarify requirements
    activities:
    - Extract [NEEDS CLARIFICATION] markers (max 3)
    - Research codebase for patterns
    - Resolve ambiguities through investigation
    - Update spec.md with clarifications
    - Document assumptions
    outputs:
    - resolved_ambiguities
    - clarified_requirements
    - updated_spec
    validation: requirements_clear

  step_5_quality_checklist:
    purpose: Generate validation checklist (Level 2+ requirement)
    level_requirement: "Level 2+ (Verification and Full)"
    activities:
    - Check documentation level - skip for Level 1, required for Level 2+
    - Load checklist.md template
    - Generate domain-specific validation items
    - Create checklist file
    - Run validation check
    outputs:
    - quality_checklist: generated
    template: .opencode/speckit/templates/checklist.md
    validation: checklist_generated

  step_6_planning:
    purpose: Create technical plan with implementation approach

    # INLINE 4-AGENT PARALLEL EXPLORATION
    # Self-contained exploration - no external skill dependency
    parallel_dispatch_note: |
      This phase dispatches 4 parallel Sonnet agents directly via Task tool.
      Agents: Architecture Explorer, Feature Explorer, Dependency Explorer, Test Explorer.
      No additional question is asked because parallel dispatch is integral to this phase.

    # 4-Agent Parallel Exploration Configuration
    inline_parallel_exploration:
      description: "4-agent parallel exploration for verified planning"
      purpose: "Spawn 4 Explore agents to discover codebase patterns before planning"

      execution:
        tool: Task
        subagent_type: explore
        model: sonnet  # Fast, cost-effective exploration
        parallel: true  # All 4 agents spawn in single message

      agents:
        architecture_explorer:
          focus: "Project structure, entry points, component connections"
          purpose: "Understand system architecture"
          prompt: |
            Explore the codebase to find how the system architecture works for: {task_description}

            Return:
            1. Your hypothesis about the architecture
            2. Full paths to all relevant files (e.g., /path/to/file.ts:lineNumber)
            3. Any patterns you noticed (component structure, module organization, etc.)

            Do NOT draw conclusions - just report findings. The main agent will verify.

        feature_explorer:
          focus: "Similar features, related patterns"
          purpose: "Find reusable patterns"
          prompt: |
            Explore the codebase to find similar features or related patterns for: {task_description}

            Return:
            1. Your hypothesis about existing similar features
            2. Full paths to all relevant files
            3. Any patterns you noticed (naming conventions, implementation patterns, etc.)

            Do NOT draw conclusions - just report findings.

        dependency_explorer:
          focus: "Imports, modules, affected areas"
          purpose: "Identify integration points"
          prompt: |
            Explore the codebase to find dependencies and integration points for: {task_description}

            Return:
            1. Your hypothesis about which modules/files will be affected
            2. Full paths to all relevant files
            3. Any patterns you noticed (dependency chains, coupling points, etc.)

            Do NOT draw conclusions - just report findings.

        test_explorer:
          focus: "Test patterns, testing infrastructure"
          purpose: "Understand verification approach"
          prompt: |
            Explore the codebase to find test patterns and testing infrastructure.

            Return:
            1. Your hypothesis about how testing works in this project
            2. Full paths to all relevant test files
            3. Any patterns you noticed (test frameworks, mocking patterns, coverage expectations, etc.)

            Do NOT draw conclusions - just report findings.

      verification:
        description: "After agents return, verify hypotheses by reading identified files"
        approach:
          - "Read each file identified by Explore agents"
          - "Verify or refute each hypothesis"
          - "Cross-reference findings across agents for consistency"
          - "Build complete mental model of architecture, affected components, integration points, risks"
          - "Resolve conflicting hypotheses by reading additional files"

      outputs:
        - architecture_findings
        - feature_findings
        - dependency_findings
        - test_findings
        - verified_mental_model

      fallback:
        on_failure: "Use inline planning activities below"
        reason: "Graceful degradation if agents unavailable"

    # FALLBACK: Inline planning if exploration fails
    activities:
    - Run check-prerequisites.sh --json --paths-only
    - Load plan.md
    - Fill Technical Context
    - Fill Constitution Check section
    - Phase 0: Generate research.md to resolve unknowns
    - Phase 1: Generate data-model.md, contracts/
    - Generate Testing Strategy
    - Generate Success Metrics
    - Import Risk Matrix from spec
    - Generate Dependencies Tables
    - Generate Phase 2-4 outlines
    - Create planning-summary.md
    outputs:
    - plan.md: technical_approach
    - planning-summary.md: overview
    - research.md: resolved_unknowns
    template: .opencode/speckit/templates/plan.md
    validation: approach_defined

  step_7_save_context:
    purpose: Save conversation context for planning documentation
    activities:
    - Invoke workflows-memory skill
    - Preserve requirements analysis and clarifications
    - Preserve technical approach decisions
    - Preserve architecture discussions
    tool_invocation:
      command: openskills read workflows-memory
      note: "Use command: openskills read workflows-memory to activate context saving"
    outputs:
    - context_file: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__planning_session.md"
    validation: context_saved_successfully

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 7
  message: "Planning phase completed successfully. Workflow terminated after step 7 (save context)."
  next_steps:
  - Review planning documentation
  - Validate technical approach
  - Use /spec_kit:implement:auto or /spec_kit:implement:confirm for implementation

# ─────────────────────────────────────────────────────────────────
# AUTONOMOUS EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
autonomous_execution:
  principle: "Execute planning workflow autonomously with self-validation at each step"

  decision_making:
  - Analyze requirements thoroughly from user inputs
  - Explore codebase to understand context
  - Make informed planning decisions
  - Document reasoning and alternatives
  - Proceed with best judgment

  validation_approach:
  - Self-validate after each planning step
  - Verify spec completeness and clarity
  - Ensure technical approach is sound
  - Validate against quality standards

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  step_validation_fails:
    action: "Review requirements, ask clarifying questions, retry step"
  spec_ambiguity_persists:
    action: "Document as assumption, add to risk matrix"
  environment_unavailable:
    action: "Skip browser testing, document limitation"
  unexpected_error:
    action: "Log error, document state, attempt graceful recovery"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - follow_workflow_sequence
  - document_all_decisions
  - validate_before_completion
  - self_validate_and_proceed
  - do_not_prompt_for_user_approval

  NEVER:
  - skip_workflow_steps
  - proceed_beyond_planning
  - make_unsupported_assumptions
  - proceed_without_self_validation
