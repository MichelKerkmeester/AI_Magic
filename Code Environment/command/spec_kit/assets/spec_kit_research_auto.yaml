# ───────────────────────────────────────────────────────────────────
# SMART SPECKIT: RESEARCH WORKFLOW (AUTONOMOUS MODE)
# ───────────────────────────────────────────────────────────────────
role: Expert Developer using Smart SpecKit for autonomous research
purpose: Spec-driven comprehensive technical investigation
action: Run SpecKit research workflow from analysis to documentation

operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: autonomous
  approvals: none
  tracking: progressive_research_documentation
  validation: continuous_self_validation

research_philosophy:
  principle: "Thoroughness first, documentation second"
  approach: "Systematic investigation with comprehensive documentation"
  mandate: "Research deeply, document comprehensively, validate findings"

# ───────────────────────────────────────────────────────────────────
# USER INPUTS (Transformed from raw text)
# ───────────────────────────────────────────────────────────────────
user_inputs:
  git_branch: |
    [GIT_BRANCH]
    Git branch name. Leave empty to auto-create as feature-{NNN}.

  spec_folder: |
    [SPEC_FOLDER]
    Spec folder path. Leave empty to auto-create next available.

  context: |
    [CONTEXT]
    Background information, technical stack, or investigating context.

  issues: |
    [ISSUES]
    Known issues, questions, problems, or unknowns to investigate.

  request: |
    [REQUEST]
    Research topic or technical question to investigate. REQUIRED.

  environment: |
    [STAGING LINK]
    Staging URL for browser-based analysis.

  scope: |
    [FILES]
    Files or folders to focus investigation on.

# ─────────────────────────────────────────────────────────────────
# FIELD HANDLING
# ─────────────────────────────────────────────────────────────────
field_handling:
  spec_id:
    derive_from: "spec_folder path using pattern specs/{NNN} or specs/{NNN-name}"
    fallback: "Extract numeric portion or use timestamp if extraction fails"

  defaults:
    git_branch_empty: "Auto-create feature-{NNN} from highest +001"
    spec_folder_empty: "Auto-create specs/{NNN} from highest +001"
    context_empty: "Infer from [REQUEST] and codebase exploration"
    issues_empty: "Investigate and discover during workflow"
    environment_empty: "Skip browser analysis steps"
    scope_empty: "Use scope_policy.default"

  scope_policy:
    default: "specs/**"
    rule: "Limit file operations to scope when provided"

# ─────────────────────────────────────────────────────────────────
# DOCUMENTATION LEVELS (Progressive Enhancement)
# ─────────────────────────────────────────────────────────────────
documentation_levels:
  level_1_baseline:
    name: "Level 1 (Baseline)"
    required_files:
    - spec.md
    - plan.md
    - tasks.md
    loc_guidance: "<100 LOC"
    use_case: "Simple changes, bug fixes, minor features"

  level_2_verification:
    name: "Level 2 (Verification)"
    required_files:
    - spec.md
    - plan.md
    - tasks.md
    - checklist.md
    loc_guidance: "100-499 LOC"
    use_case: "Medium features, refactoring, multi-file changes"

  level_3_full:
    name: "Level 3 (Full)"
    required_files:
    - spec.md
    - plan.md
    - tasks.md
    - checklist.md
    - decision-record.md
    optional_files:
    - research-spike.md
    loc_guidance: ">=500 LOC"
    use_case: "Complex features, architecture changes, high-risk modifications"

  level_selection:
    note: "LOC thresholds are SOFT GUIDANCE - choose level based on complexity and risk"
    default: "Research workflow typically supports Level 2+ or Level 3 features"

# ─────────────────────────────────────────────────────────────────
# AVAILABLE TEMPLATES
# ─────────────────────────────────────────────────────────────────
available_templates:
  # Research workflow primary outputs
  research: .opencode/speckit/templates/research.md
  research_spike: .opencode/speckit/templates/research-spike.md
  # Level 3 (Full)
  decision_record: .opencode/speckit/templates/decision-record.md
  # Level 2+ (Verification)
  checklist: .opencode/speckit/templates/checklist.md
  # Level 1+ (Baseline)
  spec: .opencode/speckit/templates/spec.md
  # Utility (any level)
  handover: .opencode/speckit/templates/handover.md
  debug_delegation: .opencode/speckit/templates/debug-delegation.md

# ─────────────────────────────────────────────────────────────────
# PARALLEL DISPATCH CONFIGURATION (AGENTS.md Compliant)
# ─────────────────────────────────────────────────────────────────
# Per AGENTS.md Section 1: ALWAYS ask before parallel dispatch (no auto-dispatch)
parallel_dispatch_config:
  enabled: true
  version: "1.0.0"

  complexity_scoring:
    domain_count:
      weight: 0.35
      domains: [code, analysis, docs, git, testing, devops]
      scoring: "1=0.0, 2=0.5, 3+=1.0"
    file_count:
      weight: 0.25
      scoring: "1-2=0.0, 3-5=0.5, 6+=1.0"
    loc_estimate:
      weight: 0.15
      scoring: "<50=0.0, 50-200=0.5, >200=1.0"
    parallel_opportunity:
      weight: 0.20
      scoring: "sequential=0.0, some=0.5, high=1.0"
    task_type:
      weight: 0.05
      scoring: "trivial=0.0, moderate=0.5, complex=1.0"

  # Decision thresholds (AGENTS.md compliant - no auto-dispatch)
  thresholds:
    direct_max: 20
    ask_min: 20
    min_domains_for_ask: 2
    # NOTE: auto_dispatch_min and min_domains_for_auto REMOVED per AGENTS.md Section 1
    # Always ask user before parallel dispatch

  session_preference:
    persist_duration_seconds: 3600

  override_phrases:
    direct: ["proceed directly", "handle directly", "skip parallel", "skip agents"]
    parallel: ["use parallel", "dispatch agents", "parallelize", "use agents"]
    auto: ["auto-decide", "auto mode", "decide for me"]

  question_template:
    method: present_options_to_user
    header: "Parallel Dispatch"
    format: |
      **Phase: {phase_name}**
      Complexity: {complexity_score}% | Domains: {domain_count} ({domains_list})

      This phase may benefit from parallel sub-agents for faster execution.
    options:
      - id: A
        label: "Handle directly"
        description: "Execute phase sequentially without parallel agents"
      - id: B
        label: "Use parallel agents"
        description: "Dispatch specialized agents for faster parallel execution"
      - id: C
        label: "Auto-decide for session"
        description: "Let system decide based on complexity thresholds (1 hour)"

  eligible_phases:
    - step_3_codebase_investigation
    - step_4_external_research
    - step_5_technical_analysis

# ─────────────────────────────────────────────────────────────────
# WORKFLOW (9 STEPS)
# ─────────────────────────────────────────────────────────────────
workflow:
  step_1_request_analysis:
    purpose: Analyze research request and define investigation scope
    activities:
    - Analyze all user inputs thoroughly
    - Define research scope and objectives
    - Verify or create spec folder structure
    - Check for existing research artifacts
    - Establish investigation boundaries
    - Identify key questions to answer
    deep_analysis:
      focus: comprehensive_research_scoping
      outputs:
      - feature_summary
      - research_objectives
      - investigation_priorities
      - key_questions
      - success_criteria
    validation: understanding_confirmed

  step_2_pre_work_review:
    purpose: Review skills folder and project standards
    activities:
    - Read and review AGENTS.md
    - Check skills folder (.opencode/skills/) for relevant coding standards
    - Extract relevant coding standards
    - Identify architectural patterns
    - Document project conventions
    - Note constraints relevant to research
    required_documents:
    - AGENTS.md
    - Skills folder (if available)
    verification: MUST_REVIEW
    validation: principles_established

  step_3_codebase_investigation:
    purpose: Explore existing codebase for patterns and implementations

    # PRE-PHASE: Smart parallel dispatch check (AGENTS.md compliant)
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, analysis]
      complexity_boost: 10
      decision_logic: |
        BEFORE starting this phase, evaluate parallel dispatch (AGENTS.md compliant):
        1. Check for override phrases in user request
        2. Check for session preference (from previous "Auto-decide" selection)
        3. Check for sequential dependencies (skip if detected)
        4. Calculate phase complexity using parallel_dispatch_config
        5. Apply thresholds:
           - <20% → proceed directly (no parallel agents)
           - ≥20% + 2 domains → ALWAYS ask user
           NOTE: No auto-dispatch - per AGENTS.md Section 1, always ask before parallel dispatch
      on_parallel_dispatch:
        agents:
          - name: "pattern_explorer"
            focus: "Search for related code patterns and implementations"
            model: "sonnet"
          - name: "architecture_analyzer"
            focus: "Analyze current architecture and integration points"
            model: "sonnet"
        dispatch_note: "Spawn agents in SINGLE message for parallel execution"
      fallback: "Proceed with activities below if dispatch fails or user chooses direct"

    activities:
    - Search for related code patterns
    - Analyze existing implementations
    - Document current architecture
    - Identify integration points
    - Map dependencies
    - Note technical debt or limitations
    outputs:
    - current_state_analysis
    - existing_patterns
    - integration_points
    - dependency_map
    validation: codebase_understood

  step_4_external_research:
    purpose: Research external documentation and best practices

    # PRE-PHASE: Smart parallel dispatch check (AGENTS.md compliant)
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [docs, analysis]
      complexity_boost: 5
      decision_logic: |
        BEFORE starting this phase, evaluate parallel dispatch (AGENTS.md compliant):
        1. Check for override phrases in user request
        2. Check for session preference (from previous "Auto-decide" selection)
        3. Check for sequential dependencies (skip if detected)
        4. Calculate phase complexity using parallel_dispatch_config
        5. Apply thresholds:
           - <20% → proceed directly (no parallel agents)
           - ≥20% + 2 domains → ALWAYS ask user
           NOTE: No auto-dispatch - per AGENTS.md Section 1, always ask before parallel dispatch
      on_parallel_dispatch:
        agents:
          - name: "documentation_researcher"
            focus: "Search official documentation and API references"
            model: "sonnet"
          - name: "best_practices_explorer"
            focus: "Analyze community best practices and alternatives"
            model: "sonnet"
        dispatch_note: "Spawn agents in SINGLE message for parallel execution"
      fallback: "Proceed with activities below if dispatch fails or user chooses direct"

    activities:
    - Search official documentation
    - Review API references
    - Analyze community best practices
    - Identify relevant libraries/tools
    - Document limitations and constraints
    - Compare alternative approaches
    outputs:
    - best_practices_summary
    - api_documentation
    - library_comparison
    - constraint_documentation
    web_research:
      approach: Search → Verify → Document
      sources:
      - official_documentation
      - technical_blogs
      - github_examples
      - stack_overflow
    validation: external_research_complete

  step_5_technical_analysis:
    purpose: Perform feasibility assessment and technical analysis

    # PRE-PHASE: Smart parallel dispatch check (AGENTS.md compliant)
    pre_phase_parallel_check:
      enabled: true
      phase_domains: [code, analysis, testing]
      complexity_boost: 15
      decision_logic: |
        BEFORE starting this phase, evaluate parallel dispatch (AGENTS.md compliant):
        1. Check for override phrases in user request
        2. Check for session preference (from previous "Auto-decide" selection)
        3. Check for sequential dependencies (skip if detected)
        4. Calculate phase complexity using parallel_dispatch_config
        5. Apply thresholds:
           - <20% → proceed directly (no parallel agents)
           - ≥20% + 2 domains → ALWAYS ask user
           NOTE: No auto-dispatch - per AGENTS.md Section 1, always ask before parallel dispatch
      on_parallel_dispatch:
        agents:
          - name: "feasibility_analyzer"
            focus: "Evaluate technical feasibility and performance"
            model: "sonnet"
          - name: "risk_assessor"
            focus: "Analyze security, scalability, and risks"
            model: "sonnet"
        dispatch_note: "Spawn agents in SINGLE message for parallel execution"
      fallback: "Proceed with activities below if dispatch fails or user chooses direct"

    activities:
    - Evaluate technical feasibility
    - Assess performance implications
    - Analyze security considerations
    - Review scalability requirements
    - Document trade-offs
    - Identify risks and mitigations
    outputs:
    - technical_specifications
    - feasibility_assessment
    - performance_analysis
    - security_review
    - risk_assessment
    validation: technical_analysis_complete

  step_6_quality_checklist:
    purpose: Generate validation checklist for research quality (Level 2+ requirement)
    level_requirement: "Level 2+ (Verification and Full)"
    activities:
    - Check documentation level - skip for Level 1, required for Level 2+
    - Load checklist.md template
    - Generate research-specific validation items
    - Include completeness checks
    - Include accuracy verification items
    - Include documentation quality checks
    outputs:
    - quality_checklist: generated
    template: .opencode/speckit/templates/checklist.md
    validation: checklist_generated

  step_7_solution_design:
    purpose: Design solution architecture based on research findings
    activities:
    - Synthesize research findings
    - Design recommended architecture
    - Define implementation patterns
    - Create integration approach
    - Document decision rationale
    - Outline implementation strategy
    outputs:
    - solution_architecture
    - implementation_patterns
    - integration_approach
    - decision_rationale
    level_3_documents:
    - decision-record-[name].md: "For significant architecture decisions (Level 3 requirement)"
    template: .opencode/speckit/templates/decision-record.md
    validation: solution_designed

  step_8_research_compilation:
    purpose: Compile all research into comprehensive documentation
    activities:
    - Load research.md
    - Fill all 17 sections systematically
    - Include executive overview
    - Document core architecture
    - Add technical specifications
    - Include constraints and limitations
    - Document integration patterns
    - Provide implementation guide
    - Add code examples
    - Include testing strategies
    - Document performance considerations
    - Add security section
    - Include troubleshooting guide
    - Add API reference
    - Include acknowledgements
    - Add appendix and changelog
    outputs:
    - research.md: comprehensive_technical_documentation
    template: .opencode/speckit/templates/research.md
    research_sections:
    - metadata
    - investigation_report
    - executive_overview
    - core_architecture
    - technical_specifications
    - constraints_limitations
    - integration_patterns
    - implementation_guide
    - code_examples
    - testing_debugging
    - performance
    - security
    - maintenance
    - api_reference
    - troubleshooting
    - acknowledgements
    - appendix_changelog
    validation: research_documented

  step_9_save_context:
    purpose: Save conversation context for documentation
    activities:
    - Invoke workflows-memory skill
    - Preserve research decisions and rationale
    - Preserve technical findings
    - Preserve code analysis results
    tool_invocation:
      command: openskills read workflows-memory
      note: "Use command: openskills read workflows-memory to activate context saving"
    outputs:
    - context_file: "[SPEC_FOLDER]/memory/[DD-MM-YY_HH-MM]__research_session.md"
    validation: context_saved_successfully

# ─────────────────────────────────────────────────────────────────
# WORKFLOW TERMINATION
# ─────────────────────────────────────────────────────────────────
termination:
  after_step: 9
  message: "Research phase completed successfully. Workflow terminated after step 9 (save context)."
  next_steps:
  - Review research.md findings
  - Validate technical recommendations
  - Run /spec_kit:plan or /spec_kit:complete to proceed with development

# ─────────────────────────────────────────────────────────────────
# AUTONOMOUS EXECUTION GUIDANCE
# ─────────────────────────────────────────────────────────────────
autonomous_execution:
  principle: "Execute research workflow autonomously with comprehensive documentation"

  decision_making:
  - Research thoroughly before conclusions
  - Document all findings systematically
  - Make informed technical recommendations
  - Document reasoning and alternatives
  - Proceed with best judgment

  validation_approach:
  - Self-validate research completeness
  - Verify findings against multiple sources
  - Ensure documentation quality
  - Validate against checklist

# ─────────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ─────────────────────────────────────────────────────────────────
error_recovery:
  research_scope_unclear:
    action: "Ask clarifying questions, narrow focus"
  external_sources_unavailable:
    action: "Document limitation, continue with available info"
  conflicting_findings:
    action: "Document both perspectives with analysis, flag for review"
  technical_dead_end:
    action: "Document findings, recommend alternative approach"

# ─────────────────────────────────────────────────────────────────
# RULES
# ─────────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - follow_workflow_sequence
  - document_all_findings
  - validate_before_completion
  - cite_sources_and_references
  - self_validate_and_proceed
  - do_not_prompt_for_user_approval
  - generate_comprehensive_documentation

  NEVER:
  - skip_workflow_steps
  - make_unsupported_claims
  - proceed_without_verification
  - submit_incomplete_research
  - expand_scope_beyond_request
